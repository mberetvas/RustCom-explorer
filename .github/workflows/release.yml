name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Cargo.toml'
      - 'src/**'

permissions:
  contents: write

jobs:
  check-version:
    name: Check Version
    runs-on: windows-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      cargo_version: ${{ steps.check.outputs.cargo_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version against latest release
        id: check
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Get Cargo.toml version
          $content = Get-Content Cargo.toml -Raw
          if ($content -match 'version\s*=\s*"([^"]+)"') {
            $cargoVerStr = $matches[1]
          } else {
            Write-Error "Cannot find version in Cargo.toml"
            exit 1
          }
          Write-Output "Current Cargo version: $cargoVerStr"

          # 2. Get latest GitHub Release
          $latestReleaseTag = gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>$null

          if ([string]::IsNullOrWhiteSpace($latestReleaseTag)) {
            $latestVerStr = "0.0.0"
            Write-Output "No previous releases found. Defaulting to 0.0.0"
          } else {
            # Remove 'v' prefix if present
            $latestVerStr = $latestReleaseTag -replace '^v', ''
            Write-Output "Latest release version: $latestVerStr"
          }

          # 3. Compare versions
          try {
            $cargoVer = [version]$cargoVerStr
            $latestVer = [version]$latestVerStr

            if ($cargoVer -gt $latestVer) {
              Write-Output "✓ NEW VERSION: $cargoVer is greater than $latestVer"
              echo "should_build=true" >> $env:GITHUB_OUTPUT
              echo "cargo_version=$cargoVerStr" >> $env:GITHUB_OUTPUT
            } else {
              Write-Output "✗ NO UPDATE: $cargoVer is not greater than $latestVer"
              echo "should_build=false" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Warning "Could not parse versions as [version] object (possibly SemVer suffixes like -beta). Using string comparison."
            # Fallback to simple string comparison if [version] fails
            if ($cargoVerStr -ne $latestVerStr) {
               echo "should_build=true" >> $env:GITHUB_OUTPUT
               echo "cargo_version=$cargoVerStr" >> $env:GITHUB_OUTPUT
            } else {
               echo "should_build=false" >> $env:GITHUB_OUTPUT
            }
          }

  build:
    name: Build and Upload
    runs-on: windows-latest
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build with optimizations
        run: cargo build --release
        shell: pwsh

      - name: Verify Build Artifact
        shell: pwsh
        run: |
          if (-Not (Test-Path "target/release/comm_browser.exe")) {
             Write-Error "target/release/comm_browser.exe not found! Check your bin name in Cargo.toml."
             exit 1
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.cargo_version }}
          name: Release v${{ needs.check-version.outputs.cargo_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            target/release/comm_browser.exe
            target/release/comm_browser.pdb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  skipped:
    name: No Release Needed
    runs-on: windows-latest
    needs: check-version
    if: needs.check-version.outputs.should_build == 'false'
    steps:
      - run: echo "Version has not changed. No build needed."